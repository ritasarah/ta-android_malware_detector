package com.albus.imagespan;

import android.support.v4.util.LruCache;
import android.text.Html;
import android.text.Spanned;
import com.albus.util.QuoteUtils;
import com.catfiz.model.Message;
import com.catfiz.util.Log;
import java.lang.ref.WeakReference;

public class HtmlSpanCache {
    private static final int MAXIMUM_HTMLSPANNED_CACHE = 500;
    private static final String TAG = "HtmlSpanCache";
    private static LruCache mCache = new LruCache(MAXIMUM_HTMLSPANNED_CACHE);
    private static WeakReference mHtmlSpanCache = new WeakReference(mCache);

    public static Spanned formattedQuotedBuilder(String str, Message message, boolean z) {
        if (str == null) {
            Log.d(TAG, "*** QUOTE NULL KEY ***");
            return Html.fromHtml(QuoteUtils.formattedQuotedBuilder(message, z));
        }
        if (mHtmlSpanCache == null) {
            Log.d(TAG, "*** QUOTE LRU CREATE ***");
            mHtmlSpanCache = new WeakReference(new LruCache(MAXIMUM_HTMLSPANNED_CACHE));
        }
        if (mHtmlSpanCache.get() == null) {
            Log.d(TAG, "*** QUOTE LRU RE-CREATE ***");
            mHtmlSpanCache = new WeakReference(new LruCache(MAXIMUM_HTMLSPANNED_CACHE));
        }
        LruCache lruCache = (LruCache) mHtmlSpanCache.get();
        Spanned spanned = (Spanned) lruCache.get(str);
        if (spanned != null) {
            Log.d(TAG, "-- QUOTE CACHE HIT: key=" + str + "---");
            return spanned;
        }
        Log.d(TAG, "-- QUOTE CREATE: key=" + str + "---");
        spanned = Html.fromHtml(QuoteUtils.formattedQuotedBuilder(message, z));
        if (str == null || spanned == null) {
            return spanned;
        }
        try {
            lruCache.put(str, spanned);
            return spanned;
        } catch (Exception e) {
            lruCache.evictAll();
            return spanned;
        }
    }

    public static Spanned fromHtml(String str, String str2) {
        if (str == null) {
            return Html.fromHtml(str2);
        }
        if (mHtmlSpanCache == null) {
            Log.d(TAG, "*** HTML LRU CREATE ***");
            mHtmlSpanCache = new WeakReference(new LruCache(MAXIMUM_HTMLSPANNED_CACHE));
        }
        if (mHtmlSpanCache.get() == null) {
            Log.d(TAG, "*** HTML LRU RE-CREATE ***");
            mHtmlSpanCache = new WeakReference(new LruCache(MAXIMUM_HTMLSPANNED_CACHE));
        }
        LruCache lruCache = (LruCache) mHtmlSpanCache.get();
        Spanned spanned = (Spanned) lruCache.get(str);
        if (spanned != null) {
            Log.d(TAG, "-- CACHE HIT: key=" + str + "---");
            return spanned;
        }
        Log.d(TAG, "-- CREATE: key=" + str + "---");
        spanned = Html.fromHtml(str2);
        if (str == null || spanned == null) {
            return spanned;
        }
        try {
            lruCache.put(str, spanned);
            return spanned;
        } catch (Exception e) {
            lruCache.evictAll();
            return spanned;
        }
    }
}
