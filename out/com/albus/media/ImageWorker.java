package com.albus.media;

import android.content.Context;
import android.content.res.Resources;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.graphics.drawable.BitmapDrawable;
import android.graphics.drawable.ColorDrawable;
import android.graphics.drawable.Drawable;
import android.graphics.drawable.TransitionDrawable;
import android.os.AsyncTask;
import android.os.Looper;
import android.widget.ImageView;
import com.catfiz.util.Log;
import com.catfiz.util.Utils;
import java.lang.ref.WeakReference;

public abstract class ImageWorker {
    private static final int FADE_IN_TIME = 100;
    public static int IMAGELOAD_CANCEL = -1;
    public static int IMAGELOAD_DONE = 0;
    public static int IMAGELOAD_PENDING = 1;
    private static final String TAG = "ImageWorker";
    protected Context mContext;
    private Bitmap mDefaultBitmap;
    private volatile boolean mExitTasksEarly = false;
    protected boolean mFadeInBitmap = false;
    private boolean mFadeInRefresh = false;
    private int mFadeInTime = FADE_IN_TIME;
    private ImageCache mImageCache = null;
    protected ImageWorkerAdapter mImageWorkerAdapter;
    private boolean mIsGroup = false;
    private Bitmap mLoadingBitmap;
    private String mLocalCacheKey = null;

    class AsyncDrawable extends BitmapDrawable {
        private final WeakReference bitmapWorkerTaskReference;

        public AsyncDrawable(Resources resources, Bitmap bitmap, BitmapWorkerTask bitmapWorkerTask) {
            super(resources, bitmap);
            this.bitmapWorkerTaskReference = new WeakReference(bitmapWorkerTask);
        }

        public BitmapWorkerTask getBitmapWorkerTask() {
            return (BitmapWorkerTask) this.bitmapWorkerTaskReference.get();
        }
    }

    class BitmapWorkerTask extends AsyncTask {
        private Object data;
        private final WeakReference imageViewReference;
        private volatile boolean mNeedEvictCache = false;
        private float mScaleX = 1.0f;
        private float mScaleY = 1.0f;
        private boolean mScaled = false;

        public BitmapWorkerTask(ImageView imageView) {
            this.imageViewReference = new WeakReference(imageView);
        }

        public BitmapWorkerTask(ImageView imageView, float f, float f2, boolean z) {
            this.imageViewReference = new WeakReference(imageView);
            this.mScaleX = f;
            this.mScaleY = f2;
            this.mScaled = z;
        }

        private ImageView getAttachedImageView() {
            ImageView imageView = (ImageView) this.imageViewReference.get();
            return this == ImageWorker.getBitmapWorkerTask(imageView) ? imageView : null;
        }

        private Bitmap resizeBitmap(Bitmap bitmap) {
            Bitmap bitmap2 = null;
            if (bitmap != null) {
                try {
                    bitmap2 = Bitmap.createScaledBitmap(bitmap, (int) (((float) bitmap.getWidth()) * this.mScaleX), (int) (((float) bitmap.getHeight()) * this.mScaleY), false);
                } catch (OutOfMemoryError e) {
                    this.mNeedEvictCache = true;
                }
                bitmap.recycle();
            }
            return bitmap2;
        }

        protected Bitmap doInBackground(Object... objArr) {
            this.data = objArr[0];
            String valueOf = String.valueOf(this.data);
            Bitmap bitmap = null;
            if (null != null || isCancelled() || getAttachedImageView() == null || ImageWorker.this.mExitTasksEarly) {
                Log.d(ImageWorker.TAG, "NOT EXECUTED: key:" + valueOf);
            } else {
                bitmap = ImageWorker.this.mIsGroup ? ImageWorker.this.processBitmap(ImageWorker.this.getMappedKey(valueOf), ImageWorker.this.mIsGroup) : ImageWorker.this.processBitmap(ImageWorker.this.getMappedKey(valueOf));
                if (bitmap != null) {
                    Log.d(ImageWorker.TAG, "CREATE!!!: " + valueOf);
                    if (this.mScaled) {
                        bitmap = resizeBitmap(bitmap);
                    }
                    if (!(ImageWorker.this.mImageCache == null || bitmap == null)) {
                        ImageWorker.this.mImageCache.addBitmapToCache(ImageWorker.this.getMappedKey(valueOf), bitmap);
                    }
                } else {
                    Log.d(ImageWorker.TAG, "BITMAP NOT FOUND: key:" + valueOf);
                }
            }
            return bitmap;
        }

        protected void onPostExecute(Bitmap bitmap) {
            if (!ImageWorker.this.inUIThread()) {
                Log.e(ImageWorker.TAG, "FATAL ERROR: Possibly OS BUG: EXIT APP");
                System.gc();
                System.exit(1);
            }
            if (this.mNeedEvictCache && ImageWorker.this.mImageCache != null) {
                ImageWorker.this.mImageCache.clearCaches();
            }
            if (isCancelled() || ImageWorker.this.mExitTasksEarly) {
                Log.d(ImageWorker.TAG, "CANCELED AFTER EXECUTED: key:" + String.valueOf(this.data));
                if (bitmap != null) {
                    bitmap.recycle();
                    return;
                }
                return;
            }
            if (bitmap != null) {
                ImageWorker.this.putBitmapInLocalCache(this.data, bitmap);
            }
            if (bitmap == null) {
                bitmap = ImageWorker.this.getDefaultBitmap(this.data);
                if (!(ImageWorker.this.mImageCache == null || bitmap == null)) {
                    ImageWorker.this.mImageCache.addBitmapToCache(ImageWorker.this.getMappedKey(String.valueOf(this.data)), bitmap);
                }
            }
            ImageView attachedImageView = getAttachedImageView();
            if (bitmap != null || attachedImageView != null) {
                if (!ImageWorker.this.inUIThread()) {
                    Log.d(ImageWorker.TAG, "We are not in UI thread. just return");
                } else if (bitmap != null && attachedImageView != null) {
                    ImageWorker.this.setImageBitmap(attachedImageView, bitmap);
                } else if (attachedImageView != null) {
                    Drawable defaultDrawable = ImageWorker.this.getDefaultDrawable(String.valueOf(this.data));
                    if (defaultDrawable != null) {
                        ImageWorker.this.setImageDrawable(attachedImageView, defaultDrawable);
                    }
                }
            }
        }

        protected void onProgressUpdate(Integer... numArr) {
        }
    }

    public abstract class ImageWorkerAdapter {
        public abstract Object getItem(int i);

        public abstract int getSize();
    }

    protected ImageWorker(Context context) {
        this.mContext = context;
    }

    public static boolean cancelPotentialWork(Object obj, ImageView imageView) {
        BitmapWorkerTask bitmapWorkerTask = getBitmapWorkerTask(imageView);
        if (bitmapWorkerTask == null) {
            return true;
        }
        Object access$000 = bitmapWorkerTask.data;
        if (access$000 != null && access$000.equals(obj)) {
            return false;
        }
        bitmapWorkerTask.cancel(true);
        return true;
    }

    public static void cancelWork(ImageView imageView) {
        BitmapWorkerTask bitmapWorkerTask = getBitmapWorkerTask(imageView);
        if (bitmapWorkerTask != null) {
            bitmapWorkerTask.cancel(true);
        }
    }

    private static BitmapWorkerTask getBitmapWorkerTask(ImageView imageView) {
        if (imageView != null) {
            Drawable drawable = imageView.getDrawable();
            if (drawable instanceof AsyncDrawable) {
                return ((AsyncDrawable) drawable).getBitmapWorkerTask();
            }
        }
        return null;
    }

    private Bitmap getLoadingBitmap(Object obj) {
        String valueOf = String.valueOf(obj);
        if (isInLocalCache(valueOf)) {
            Bitmap bitmapFromLocalCache = getBitmapFromLocalCache(valueOf);
            if (bitmapFromLocalCache != null) {
                return bitmapFromLocalCache;
            }
        }
        return this.mLoadingBitmap;
    }

    private boolean inUIThread() {
        return Looper.myLooper() == Looper.getMainLooper();
    }

    public ImageWorkerAdapter getAdapter() {
        return this.mImageWorkerAdapter;
    }

    protected Bitmap getBitmapFromLocalCache(Object obj) {
        return null;
    }

    protected Bitmap getDefaultBitmap(Object obj) {
        return this.mDefaultBitmap;
    }

    protected Drawable getDefaultDrawable(Object obj) {
        return null;
    }

    public int getFadeInTime() {
        return this.mFadeInTime;
    }

    public ImageCache getImageCache() {
        return this.mImageCache;
    }

    public String getLocalCacheKey() {
        return this.mLocalCacheKey;
    }

    protected String getMappedKey(String str) {
        return str;
    }

    public boolean isExitTasksEarly() {
        return this.mExitTasksEarly;
    }

    public boolean isInLocalCache(String str) {
        return (str == null || this.mLocalCacheKey == null) ? false : this.mLocalCacheKey.equals(str);
    }

    public int loadImage(int i, ImageView imageView) {
        if (this.mImageWorkerAdapter != null) {
            return loadImage(this.mImageWorkerAdapter.getItem(i), imageView, true);
        }
        throw new NullPointerException("Data not set, must call setAdapter() first.");
    }

    public int loadImage(Object obj, ImageView imageView) {
        this.mIsGroup = false;
        return loadImage(obj, imageView, true, 1.0f, 1.0f, false);
    }

    public int loadImage(Object obj, ImageView imageView, boolean z) {
        return loadImage(obj, imageView, z, 1.0f, 1.0f, false);
    }

    public int loadImage(Object obj, ImageView imageView, boolean z, float f, float f2, boolean z2) {
        Bitmap bitmap = null;
        if (!inUIThread()) {
            Log.e(TAG, "FATAL: We are not in UI thread: Load image CANCEL");
            return IMAGELOAD_CANCEL;
        } else if (obj == null) {
            Log.d(TAG, "loadImage with NULL data");
            imageView.setImageBitmap(getLoadingBitmap(null));
            return IMAGELOAD_DONE;
        } else {
            String valueOf = String.valueOf(obj);
            if (valueOf == null || valueOf.isEmpty()) {
                Log.d(TAG, "loadImage with NULL datakey");
                imageView.setImageBitmap(getLoadingBitmap(null));
                return IMAGELOAD_DONE;
            }
            if (this.mImageCache != null) {
                bitmap = this.mImageCache.getBitmapFromMemCache(getMappedKey(valueOf));
            }
            if (bitmap == null) {
                bitmap = getBitmapFromLocalCache(obj);
            }
            if (bitmap != null) {
                Log.d(TAG, "IMAGE CACHE HIT!!!: " + valueOf);
                if (this.mFadeInRefresh) {
                    setImageBitmap(imageView, bitmap);
                } else {
                    imageView.setImageBitmap(bitmap);
                }
                return IMAGELOAD_DONE;
            }
            if (cancelPotentialWork(obj, imageView)) {
                if (!z || this.mExitTasksEarly) {
                    imageView.setImageBitmap(getLoadingBitmap(obj));
                } else {
                    BitmapWorkerTask bitmapWorkerTask = z2 ? new BitmapWorkerTask(imageView, f, f2, z2) : new BitmapWorkerTask(imageView);
                    imageView.setImageDrawable(new AsyncDrawable(this.mContext.getResources(), getLoadingBitmap(null), bitmapWorkerTask));
                    if (Utils.hasHoneycomb()) {
                        bitmapWorkerTask.executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, new Object[]{obj});
                    } else {
                        bitmapWorkerTask.execute(new Object[]{obj});
                    }
                    Log.d(TAG, "Execute: " + valueOf);
                }
            }
            return IMAGELOAD_PENDING;
        }
    }

    public int loadImage(Object obj, boolean z, ImageView imageView) {
        this.mIsGroup = z;
        return loadImage(obj, imageView, true, 1.0f, 1.0f, false);
    }

    protected abstract Bitmap processBitmap(Object obj);

    protected Bitmap processBitmap(Object obj, boolean z) {
        return null;
    }

    protected void putBitmapInLocalCache(Object obj, Bitmap bitmap) {
        setLocalCacheKey(String.valueOf(obj));
    }

    public void setAdapter(ImageWorkerAdapter imageWorkerAdapter) {
        this.mImageWorkerAdapter = imageWorkerAdapter;
    }

    public void setDefaultBitmap(int i) {
        this.mDefaultBitmap = BitmapFactory.decodeResource(this.mContext.getResources(), i);
    }

    public void setDefaultBitmap(Bitmap bitmap) {
        this.mDefaultBitmap = bitmap;
    }

    public void setExitTasksEarly(boolean z) {
        this.mExitTasksEarly = z;
    }

    public void setFadeInRefresh(boolean z) {
        this.mFadeInRefresh = z;
    }

    protected void setImageBitmap(ImageView imageView, Bitmap bitmap) {
        if (this.mFadeInBitmap) {
            if (getLoadingBitmap(null) != null) {
                Drawable transitionDrawable = new TransitionDrawable(new Drawable[]{new BitmapDrawable(this.mContext.getResources(), getLoadingBitmap(null)), new BitmapDrawable(this.mContext.getResources(), bitmap)});
                imageView.setImageDrawable(transitionDrawable);
                transitionDrawable.startTransition(this.mFadeInTime);
                return;
            }
            Drawable transitionDrawable2 = new TransitionDrawable(new Drawable[]{new ColorDrawable(17170445), new BitmapDrawable(this.mContext.getResources(), bitmap)});
            imageView.setImageDrawable(transitionDrawable2);
            transitionDrawable2.startTransition(this.mFadeInTime);
            return;
        }
        imageView.setImageBitmap(bitmap);
    }

    public void setImageCache(ImageCache imageCache) {
        this.mImageCache = imageCache;
    }

    protected void setImageDrawable(ImageView imageView, Drawable drawable) {
        if (this.mFadeInBitmap) {
            if (getLoadingBitmap(null) != null) {
                Drawable transitionDrawable = new TransitionDrawable(new Drawable[]{new BitmapDrawable(this.mContext.getResources(), getLoadingBitmap(null)), drawable});
                imageView.setImageDrawable(transitionDrawable);
                transitionDrawable.startTransition(this.mFadeInTime);
                return;
            }
            Drawable transitionDrawable2 = new TransitionDrawable(new Drawable[]{new ColorDrawable(17170445), drawable});
            imageView.setImageDrawable(transitionDrawable2);
            transitionDrawable2.startTransition(this.mFadeInTime);
            return;
        }
        imageView.setImageDrawable(drawable);
    }

    public void setImageFadeIn(boolean z) {
        this.mFadeInBitmap = z;
    }

    public void setImageFadeIn(boolean z, int i) {
        this.mFadeInBitmap = z;
        this.mFadeInTime = i;
    }

    public void setLoadingImage(int i) {
        this.mLoadingBitmap = BitmapFactory.decodeResource(this.mContext.getResources(), i);
    }

    public void setLoadingImage(Bitmap bitmap) {
        this.mLoadingBitmap = bitmap;
    }

    public void setLocalCacheKey(String str) {
        this.mLocalCacheKey = str;
    }
}
