package com.albus.fragment;

import android.app.Dialog;
import android.content.Context;
import android.content.DialogInterface;
import android.content.SharedPreferences;
import android.os.Bundle;
import android.preference.PreferenceManager;
import android.support.v4.app.DialogFragment;
import android.support.v4.app.Fragment;
import android.view.LayoutInflater;
import android.view.View;
import android.view.View.OnClickListener;
import android.view.ViewGroup;
import android.widget.AdapterView;
import android.widget.AdapterView.OnItemClickListener;
import android.widget.ArrayAdapter;
import android.widget.Button;
import android.widget.LinearLayout;
import android.widget.ListView;
import android.widget.TextView;
import com.albus.dialog.AlbusDialog;
import com.albus.dialog.AlbusDialogInterface;
import com.albus.util.AlbusModelObject;
import com.albus.util.AlbusUtils;
import com.catfiz.R;
import com.catfiz.base.Callback;
import com.catfiz.base.Callback.UserFetchGroupsCallback;
import com.catfiz.base.Catfiz;
import com.catfiz.base.ICatfiz;
import com.catfiz.model.Group;
import com.catfiz.signal.Signal;
import java.lang.ref.WeakReference;
import java.util.Arrays;
import java.util.List;

public class SettingChatGroupFragment extends Fragment implements OnClickListener, ICatfiz {
    private static final String CHAT_OUT_OF_DATE = "dataOutOfDate";
    private static final String GROUP_OUT_OF_DATE = "poolDataOutOfDate";
    private int chat_ood;
    private int group_ood;
    private Catfiz mCatfiz = null;
    private List mChatOodList;
    private List mGroupOodList;
    private LinearLayout mLlChatOutOfDate;
    private LinearLayout mLlClearGroupConv;
    private LinearLayout mLlGroupOutOfDate;
    private SharedPreferences mPref;
    private TextView mTvChatOutOfDate;
    private TextView mTvGroupOutOfDate;

    public class FetchGroupsCB implements UserFetchGroupsCallback {
        private WeakReference mThisFragmentRef;

        public FetchGroupsCB(SettingChatGroupFragment settingChatGroupFragment) {
            this.mThisFragmentRef = new WeakReference(settingChatGroupFragment);
        }

        public void onData(List list) {
            SettingChatGroupFragment settingChatGroupFragment = (SettingChatGroupFragment) this.mThisFragmentRef.get();
            if (settingChatGroupFragment != null) {
                for (int i = 0; i < list.size(); i++) {
                    if (i == list.size() - 1) {
                        settingChatGroupFragment.deleteGroupConv((Group) list.get(i), true);
                    } else {
                        settingChatGroupFragment.deleteGroupConv((Group) list.get(i), false);
                    }
                }
            }
        }

        public void onError() {
        }

        public void onSuccess() {
        }
    }

    class SettingChatGroupDialog implements AlbusDialogInterface {
        private SettingChatGroupDialog() {
        }

        public void onCancelDialog(int i, DialogInterface dialogInterface, Context context) {
        }

        public void onCreateDialog(int i, final DialogFragment dialogFragment, View view, Bundle bundle, Context context) {
            TextView textView = (TextView) view.findViewById(R.id.tv_title);
            TextView textView2 = (TextView) view.findViewById(R.id.tv_notif);
            TextView textView3 = (TextView) view.findViewById(R.id.tv_name);
            Button button = (Button) view.findViewById(R.id.btn_cancel);
            Button button2 = (Button) view.findViewById(R.id.btn_action);
            CharSequence string = context.getResources().getString(R.string.delete_allgroup_chat_notif);
            CharSequence replace = context.getResources().getString(R.string.delete_group_chat).replace("[count]", "");
            if (AlbusUtils.isLocale("en")) {
                replace = replace + "?";
            }
            textView2.setText(string);
            textView.setText(replace);
            textView.setVisibility(0);
            button.setText(context.getResources().getString(R.string.btn_cancel));
            button2.setText(context.getResources().getString(R.string.btn_clear));
            button.setOnClickListener(new OnClickListener() {
                public void onClick(View view) {
                    dialogFragment.dismiss();
                }
            });
            button2.setOnClickListener(new OnClickListener() {
                public void onClick(View view) {
                    SettingChatGroupFragment.this.mCatfiz.userFetchGroups(new FetchGroupsCB(SettingChatGroupFragment.this));
                    dialogFragment.dismiss();
                }
            });
        }

        public void onDismissDialog(int i, DialogFragment dialogFragment, View view, Bundle bundle) {
        }

        public void onShowDialog(int i, DialogFragment dialogFragment, View view, Bundle bundle) {
        }
    }

    private void deleteGroupConv(Group group, final boolean z) {
        this.mCatfiz.groupClearConferenceMessages(group.getGroupID(), new Callback() {
            public void onError() {
            }

            public void onSuccess() {
                if (z) {
                    AlbusUtils.setToastView(SettingChatGroupFragment.this.getActivity(), SettingChatGroupFragment.this.getString(R.string.clear_all_group_chat));
                }
            }
        });
    }

    public static SettingChatGroupFragment newInstance() {
        return new SettingChatGroupFragment();
    }

    private void showDialogChooserChatOutOfDate() {
        final Dialog dialog = new Dialog(getActivity(), 16973941);
        View inflate = getActivity().getLayoutInflater().inflate(R.layout.dialog_list_chat_outofdate, null);
        TextView textView = (TextView) inflate.findViewById(R.id.tv_title);
        final Object arrayAdapter = new ArrayAdapter(getActivity(), R.layout.item_list_dialog);
        arrayAdapter.addAll(this.mChatOodList);
        ListView listView = (ListView) inflate.findViewById(R.id.listview);
        listView.setAdapter(arrayAdapter);
        listView.setOnItemClickListener(new OnItemClickListener() {
            public void onItemClick(AdapterView adapterView, View view, int i, long j) {
                SettingChatGroupFragment.this.mTvChatOutOfDate.setText((String) arrayAdapter.getItem(i));
                SettingChatGroupFragment.this.mPref.edit().putInt(SettingChatGroupFragment.CHAT_OUT_OF_DATE, i + 1).commit();
                dialog.dismiss();
            }
        });
        textView.setText(getActivity().getString(R.string.chat_out_of_date));
        dialog.setContentView(inflate);
        dialog.show();
    }

    private void showDialogChooserGroupOutOfDate() {
        final Dialog dialog = new Dialog(getActivity(), 16973941);
        View inflate = getActivity().getLayoutInflater().inflate(R.layout.dialog_list_chat_outofdate, null);
        TextView textView = (TextView) inflate.findViewById(R.id.tv_title);
        final Object arrayAdapter = new ArrayAdapter(getActivity(), R.layout.item_list_dialog);
        arrayAdapter.addAll(this.mGroupOodList);
        ListView listView = (ListView) inflate.findViewById(R.id.listview);
        listView.setAdapter(arrayAdapter);
        listView.setOnItemClickListener(new OnItemClickListener() {
            public void onItemClick(AdapterView adapterView, View view, int i, long j) {
                SettingChatGroupFragment.this.mTvGroupOutOfDate.setText((String) arrayAdapter.getItem(i));
                SettingChatGroupFragment.this.mPref.edit().putInt(SettingChatGroupFragment.GROUP_OUT_OF_DATE, i + 1).commit();
                dialog.dismiss();
            }
        });
        textView.setText(getActivity().getString(R.string.group_out_of_date));
        dialog.setContentView(inflate);
        dialog.show();
    }

    public void onActivityCreated(Bundle bundle) {
        super.onActivityCreated(bundle);
        this.mChatOodList = Arrays.asList(getActivity().getResources().getStringArray(R.array.list_ood));
        this.mGroupOodList = Arrays.asList(getActivity().getResources().getStringArray(R.array.list_ood));
        this.mTvChatOutOfDate.setText("" + ((String) this.mChatOodList.get(this.chat_ood - 1)));
        this.mTvGroupOutOfDate.setText("" + ((String) this.mGroupOodList.get(this.group_ood - 1)));
    }

    public void onCatfizStarted() {
    }

    public void onCatfizStopped() {
    }

    public void onClick(View view) {
        switch (view.getId()) {
            case R.id.ll_chat_ood:
                showDialogChooserChatOutOfDate();
                return;
            case R.id.ll_group_ood:
                showDialogChooserGroupOutOfDate();
                return;
            case R.id.ll_clear_all:
                Bundle bundle = new Bundle();
                bundle.putInt(AlbusModelObject.DIALOG, 19);
                AlbusDialog.showDialog(19, new SettingChatGroupDialog(), getActivity(), bundle, getActivity().getSupportFragmentManager());
                return;
            default:
                return;
        }
    }

    public void onCreate(Bundle bundle) {
        super.onCreate(bundle);
        this.mCatfiz = new Catfiz(getActivity(), this);
    }

    public View onCreateView(LayoutInflater layoutInflater, ViewGroup viewGroup, Bundle bundle) {
        View inflate = layoutInflater.inflate(R.layout.fragment_setting_chatgroup, viewGroup, false);
        this.mLlChatOutOfDate = (LinearLayout) inflate.findViewById(R.id.ll_chat_ood);
        this.mTvChatOutOfDate = (TextView) inflate.findViewById(R.id.tv_chat_ood);
        this.mLlGroupOutOfDate = (LinearLayout) inflate.findViewById(R.id.ll_group_ood);
        this.mTvGroupOutOfDate = (TextView) inflate.findViewById(R.id.tv_group_ood);
        this.mLlClearGroupConv = (LinearLayout) inflate.findViewById(R.id.ll_clear_all);
        this.mLlChatOutOfDate.setOnClickListener(this);
        this.mLlGroupOutOfDate.setOnClickListener(this);
        this.mLlClearGroupConv.setOnClickListener(this);
        this.mPref = PreferenceManager.getDefaultSharedPreferences(getActivity());
        this.chat_ood = 1;
        try {
            this.chat_ood = this.mPref.getInt(CHAT_OUT_OF_DATE, 1);
        } catch (ClassCastException e) {
            this.mPref.edit().remove(CHAT_OUT_OF_DATE).commit();
        }
        this.group_ood = 1;
        try {
            this.group_ood = this.mPref.getInt(GROUP_OUT_OF_DATE, 1);
        } catch (ClassCastException e2) {
            this.mPref.edit().remove(GROUP_OUT_OF_DATE).commit();
        }
        return inflate;
    }

    public void onRegisterProgress() {
    }

    public boolean onSignalEvent(Signal signal) {
        return false;
    }
}
