package com.catfiz.service;

import android.os.Environment;
import com.catfiz.media.StorageDir;
import com.catfiz.util.Log;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.PrintWriter;
import java.io.StringWriter;
import java.io.Writer;
import java.lang.Thread.UncaughtExceptionHandler;

public class CatfishUncaughtExceptionHandler implements UncaughtExceptionHandler {
    private static final String TAG = "CatfishUncaughtExceptionHandler";
    private UncaughtExceptionHandler defaultUEH = Thread.getDefaultUncaughtExceptionHandler();

    private static boolean isSDCARDMounted() {
        return Environment.getExternalStorageState().equals("mounted");
    }

    public void uncaughtException(Thread thread, Throwable th) {
        Log.d(TAG, "CATCH exception: " + th.toString());
        Writer stringWriter = new StringWriter();
        PrintWriter printWriter = new PrintWriter(stringWriter);
        th.printStackTrace(printWriter);
        String obj = stringWriter.toString();
        printWriter.close();
        if (isSDCARDMounted()) {
            File file = new File(StorageDir.getMediaDir(7));
            if (!file.exists()) {
                file.mkdirs();
            }
            try {
                FileOutputStream fileOutputStream = new FileOutputStream(new File(file, CatfishService.FILE_STACKTRACE));
                fileOutputStream.write(obj.getBytes());
                fileOutputStream.close();
            } catch (IOException e) {
                Log.e(TAG, "FAIL write stacktrace to file: " + e.getMessage());
            }
        }
        this.defaultUEH.uncaughtException(thread, th);
        thread.getThreadGroup().destroy();
    }
}
