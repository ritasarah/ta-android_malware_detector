package com.catfiz.ecash.api;

import android.util.Log;
import com.catfiz.ecash.ECash;
import com.catfiz.ecash.api.ResponseStatus.StatusCode;
import com.catfiz.ecash.http.HttpResult;
import com.catfiz.ecash.http.SimpleHttpClient;
import com.catfiz.ecash.model.ECashAccount;
import java.io.UnsupportedEncodingException;
import java.util.List;
import org.apache.http.client.entity.UrlEncodedFormEntity;
import org.json.JSONException;

public abstract class ApiBase implements Runnable {
    private static final String TAG = ApiBase.class.getName();
    protected ECashAccount mAccount = null;
    private Result mResult = null;

    public ApiBase(ECashAccount eCashAccount) {
        this.mAccount = eCashAccount;
    }

    private void defaultPostAction() {
        if (getResult().getStatusCode() == StatusCode.RESPONSE_TOKEN_EXPIRED) {
            ECash.clearAccountCredentials();
        } else if (getResult().getStatusCode() == StatusCode.RESPONSE_REG_KEY_NOT_FOUND) {
            ECash.clearAccount();
        }
    }

    public abstract List generateRequest();

    public Result getResult() {
        return this.mResult;
    }

    public abstract String getUrl();

    public abstract void onPostResponse(Result result);

    public abstract Result parseResponse(String str);

    public void run() {
        SimpleHttpClient simpleHttpClient = new SimpleHttpClient();
        List generateRequest = generateRequest();
        try {
            Log.d(TAG, " --- REQUEST --- url = " + getUrl() + " params = " + generateRequest.toString());
            HttpResult requestPost = simpleHttpClient.requestPost(getUrl(), new UrlEncodedFormEntity(generateRequest));
            Log.d(TAG, " --- RESPONSE --- " + requestPost.getResponseData());
            this.mResult = parseResponse(requestPost.getResponseData());
            defaultPostAction();
            onPostResponse(this.mResult);
        } catch (UnsupportedEncodingException e) {
            e.printStackTrace();
        } catch (JSONException e2) {
            e2.printStackTrace();
        }
    }
}
