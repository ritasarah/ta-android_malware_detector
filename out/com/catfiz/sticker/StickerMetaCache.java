package com.catfiz.sticker;

import android.content.Context;
import android.support.v4.app.FragmentActivity;
import android.support.v4.util.LruCache;
import com.catfiz.util.Log;
import com.catfiz.util.RetainFragment;
import com.catfiz.util.RetainFragment.ObjectFinalizer;

public class StickerMetaCache implements ObjectFinalizer {
    private static final int DEFAULT_DISK_CACHE_SIZE = 10485760;
    private static final boolean DEFAULT_MEM_CACHE_ENABLED = true;
    private static final int DEFAULT_MEM_CACHE_SIZE = 5242880;
    private static final String TAG = "StickerMetaCache";
    private MetaLruCache mMemoryCache = null;

    class MetaLruCache extends LruCache {
        public MetaLruCache(int i) {
            super(i);
        }

        protected int sizeOf(String str, StickerMessageObject stickerMessageObject) {
            return stickerMessageObject.stickerFrameCount <= 0 ? 1 : stickerMessageObject.stickerFrameCount;
        }
    }

    public class StickerMetaCacheParams {
        public int memCacheSize = StickerMetaCache.DEFAULT_MEM_CACHE_SIZE;
        public boolean memoryCacheEnabled = StickerMetaCache.DEFAULT_MEM_CACHE_ENABLED;
        public String uniqueName;

        public StickerMetaCacheParams(String str) {
            this.uniqueName = str;
        }
    }

    public StickerMetaCache(Context context, StickerMetaCacheParams stickerMetaCacheParams) {
        init(context, stickerMetaCacheParams);
    }

    public StickerMetaCache(Context context, String str) {
        init(context, new StickerMetaCacheParams(str));
    }

    public static StickerMetaCache findOrCreateCache(FragmentActivity fragmentActivity, StickerMetaCacheParams stickerMetaCacheParams) {
        StickerMetaCache stickerMetaCache;
        RetainFragment findOrCreateRetainFragment = RetainFragment.findOrCreateRetainFragment(fragmentActivity.getSupportFragmentManager());
        try {
            stickerMetaCache = (StickerMetaCache) findOrCreateRetainFragment.getObject();
        } catch (ClassCastException e) {
            stickerMetaCache = null;
        }
        if (stickerMetaCache == null) {
            Log.d(TAG, "Sticker Meta Cache NOT FOUND !!!: CREATE NEW");
            stickerMetaCache = new StickerMetaCache((Context) fragmentActivity, stickerMetaCacheParams);
            findOrCreateRetainFragment.setObject(stickerMetaCache);
            return stickerMetaCache;
        }
        Log.d(TAG, "Sticker Meta Cache FOUND !!!: REUSE");
        return stickerMetaCache;
    }

    public static StickerMetaCache findOrCreateCache(FragmentActivity fragmentActivity, String str) {
        return findOrCreateCache(fragmentActivity, new StickerMetaCacheParams(str));
    }

    private void init(Context context, StickerMetaCacheParams stickerMetaCacheParams) {
        if (stickerMetaCacheParams.memoryCacheEnabled) {
            this.mMemoryCache = new MetaLruCache(stickerMetaCacheParams.memCacheSize);
        }
    }

    public void clearCaches() {
        if (this.mMemoryCache != null) {
            this.mMemoryCache.evictAll();
        }
    }

    public synchronized StickerMessageObject getMetadata(String str) {
        return this.mMemoryCache != null ? (StickerMessageObject) this.mMemoryCache.get(str) : null;
    }

    public void onObjectDestroyed() {
    }

    public synchronized void putMetadata(String str, StickerMessageObject stickerMessageObject) {
        if (!(str == null || stickerMessageObject == null)) {
            if (this.mMemoryCache != null && this.mMemoryCache.get(str) == null) {
                try {
                    this.mMemoryCache.put(str, stickerMessageObject);
                } catch (Exception e) {
                    this.mMemoryCache.evictAll();
                }
            }
        }
    }

    public void removeCache(String str) {
        if (this.mMemoryCache != null) {
            this.mMemoryCache.remove(str);
        }
    }
}
