package com.catfiz.localstorage;

import android.support.v4.view.MotionEventCompat;
import com.catfiz.util.Log;
import java.io.InputStream;

public class CatfizStorageInputStream extends InputStream {
    private static final String TAG = "CatfizStorageInputStream";
    private int mByteIndex = 0;
    private ChunkStorage mChunkStorage = null;
    private int mDataId = -1;
    private String mDataKey = null;
    private int mIndex = 0;
    private byte[] mTempBuffer = new byte[ChunkStorage.MAX_CHUNK_SIZE];

    public CatfizStorageInputStream(ChunkStorage chunkStorage, String str) {
        this.mChunkStorage = chunkStorage;
        this.mDataKey = str;
        this.mChunkStorage.setBeginTransaction();
        this.mDataId = this.mChunkStorage.getDataId(this.mDataKey);
        if (this.mDataId == -1) {
            throw new DataNotFoundException();
        }
    }

    public void close() {
        this.mChunkStorage.setEndTransaction();
        super.close();
    }

    public int read() {
        int i = this.mByteIndex % ChunkStorage.MAX_CHUNK_SIZE;
        if (i == 0) {
            this.mIndex = this.mByteIndex / ChunkStorage.MAX_CHUNK_SIZE;
            this.mTempBuffer = this.mChunkStorage.getChunk(this.mDataId, this.mIndex);
            if (this.mTempBuffer == null || this.mTempBuffer.length == 0) {
                return -1;
            }
        }
        if (i >= this.mTempBuffer.length) {
            Log.d(TAG, " Buffer = -1 ");
            return -1;
        }
        byte b = this.mTempBuffer[i];
        this.mByteIndex++;
        return b & MotionEventCompat.ACTION_MASK;
    }
}
