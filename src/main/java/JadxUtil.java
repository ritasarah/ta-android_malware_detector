import jadx.api.JadxDecompiler;
import jadx.core.utils.exceptions.JadxException;
import org.apache.commons.io.FileUtils;
import org.apache.commons.io.FilenameUtils;

import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.concurrent.*;

/**
 * Created by ASUS on 6/3/2016.
 */
public class JadxUtil {
//    private ArrayList<ExtractedFeatures> manifests;

    JadxUtil(){
//        manifests = new ArrayList<ExtractedFeatures>();
    }

    public void openListApk(final File folder,String filePath) {

        //        ArrayList<ExtractedFeatures> manifests = new ArrayList<ExtractedFeatures>();
        ExtractedFeatures result = new ExtractedFeatures();
        result.printHeaderArff(filePath);
        Callable<ExtractedFeatures> callable;

        for (final File fileEntry : folder.listFiles()) {
            System.gc();
            try {
                FileUtils.cleanDirectory(new File("out"));
            } catch (IOException e) {
                e.printStackTrace();
            }
            if (fileEntry.isDirectory()) {
                openListApk(fileEntry,filePath);
            } else {
                result = new ExtractedFeatures();
                System.out.println(fileEntry.getAbsolutePath().toString());

//                if(FilenameUtils.getExtension(fileEntry.getName()).equals("apk")){
//                    try {
                // Start coba2 program with Anda <3 <3
                callable = new Callable<ExtractedFeatures>() {
                    public ExtractedFeatures call() throws Exception {
                        return openApk(fileEntry.getCanonicalPath().toString());
                    }
                };
                ExecutorService executorService = Executors.newCachedThreadPool();
                Future<ExtractedFeatures> task = executorService.submit(callable);

                try {
                    // ok, wait for 30 seconds max
                    result = task.get(60, TimeUnit.SECONDS);
                    System.out.println("Finished with result: " + result);

                } catch (ExecutionException e) {
//                    throw new RuntimeException(e);
                    System.out.println("exec exception");
                } catch (TimeoutException e) {
                    System.out.println("timeout...");
                } catch (InterruptedException e) {
                    System.out.println("interrupted");
                }
                // End coba2 program with Anda <3 <3 kyaa ganbatte!!

//                        manifests.add(openApk(fileEntry.getCanonicalPath().toString()));
                result.setApkName(fileEntry.getName());

                if(fileEntry.getAbsolutePath().toString().contains("beign")){
                    result.setMalware(false);
                }else {
                    result.setMalware(true);
                }

                result.printDatasetArff(filePath);
                if(FilenameUtils.getExtension(fileEntry.getName()).equals("apk")){
                    fileEntry.delete();
                }

//                    } catch (IOException e) {
//                        e.printStackTrace();
//                    }

//                }
            }
        }
    }

    public void getAllApk(String pathFile,String arffLoc){
        final File folder = new File(pathFile);

        openListApk(folder,arffLoc);

    }

    public ExtractedFeatures openApk(String apk){
        JadxUtil jUtil = new JadxUtil();
        jUtil.jadxExtraction(apk);
        ExtractedFeatures manifest = new ExtractedFeatures();

        manifest.getPermission();
        manifest.printPermission();

        manifest.getAPILevel();
        manifest.printAPILevel();

        manifest.getSuspiciousCalls();
        manifest.printSuspiciousCalls();
        return manifest;
    }

    public void jadxExtraction(String appname){

        try {
            FileUtils.cleanDirectory(new File("out"));
        } catch (IOException e) {
            e.printStackTrace();
        }

        try {
            JadxDecompiler jadx = new JadxDecompiler();

            jadx.loadFile(new File(appname));
            jadx.setOutputDir(new File("out"));
            jadx.save();
        } catch (JadxException e) {
            e.printStackTrace();
        }

    }

//    public ArrayList<ExtractedFeatures> getManifests(){
//        return manifests;
//    }

}
